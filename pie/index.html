<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <!--Import Google Icon Font-->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!--Import materialize.css-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <title>Operations: Orders</title>
  <!--Let browser know website is optimized for mobile-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body>
  <div class="">
    <div class="row">
      <div class="col s4 m3">
        <!-- Switch -->
        <div class="switch">
          <label>
            Hide
            <input id="hidetoggle" onclick="hider()" type="checkbox" checked>
            <span class="lever"></span>
            Show
          </label>
        </div>
      </div>
      <div class="col s4 m3">
        <span style="font-weight: bold;">Status: <span id="active1_off" class="red-text">Inactive</span><span
            id="active1_on" class="hide green-text">Active</span>
          <span id="active1_load" class="hide orange-text">Loading...</span></span>
        </span>
      </div>
    </div>
    <div class="row" id="opts_div">
      <div class="col s12 m6">
        <div class="input-field col s9 m8">
          <select id="timeframe1" onchange="timeFrameChange()">
            <option value="" disabled selected>Timeframe</option>
            <option value="1" selected>Today</option>
            <option value="2">Past Week</option>
            <option value="3">Custom</option>
          </select>
          <label>Choose Timeframe</label>
        </div>
        <div class="input-field col s3 m4">
          <i class="material-icons prefix hide-on-small-only">timer</i>
          <input type="number" min="1" max="60" value="1" onChange="resetTimer(this.value)" /> <span
            class="right">minute(s)</span>
          <label>Refresh</label>
        </div>
        <div class="input-field col s6 time1">
          <input id="start1" type="text" onChange="setDate(this.value, 'start1')" class="datepicker" />
          <label for="start1">Start</label>
        </div>
        <div class="input-field col s6 time1">
          <input id="end1" type="text" onChange="setDate(this.value, 'end1')" class="datepicker" />
          <label for="end1">End</label>
        </div>
        <div class="input-field col s9">
          <select id="comp1" onChange="validateSelect1(this)" multiple required>
            <option value="10">Markham Courier Service Limited</option>
            <option value="90">Netwide Freight Systems Inc.(US)</option>
            <option value="20">TRANS-ONTARIO EXPRESS(LOCAL)</option>
            <option value="35">Trans-Ontario Express (Expedite) (US)</option>
            <option value="30">Netwide Freight Systems Inc. (CDN)</option>
            <option value="65">Trans-Ontario Express (Expedite) (CDN)</option>
            <option value="37">NETWIDE FREIGHT SYSTEMS LTD.</option>
            <option value="80">Netwide Cargo International LTD</option>
          </select>
          <label>Company Selection</label>
        </div>
        <div class="col s3 input-field">
          <button onClick="activateChart(1)" class="btn waves-effect waves-light" type="button" name="action">Generate
            <i class="material-icons right">send</i>
          </button>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col s12 m6"><canvas id="chart1" width="100" height="100"></canvas></div>
      <div class="col s12 m6"><canvas id="chart2" width="100" height="100"></canvas></div>
    </div>
  </div>
  <!--JavaScript at end of body for optimized loading-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.4.1/dist/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"
    integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    let tried = false;
    let current_num = 0;
    let active1 = false;
    let oilCanvas, chart1;
    let start1 = moment(), end1 = moment(); //.subtract(1, 'days'), end1 = moment();
    let intervalTime = 60000;
    let intTimer = setInterval(runIntProcess, intervalTime);
    let loading = false;

    function createBlankChart(chart_id,) {
      oilCanvas = document.getElementById(chart_id);

      //Chart.defaults.global.defaultFontFamily = "Lato";
      // Chart.defaults.global.defaultFontSize = 18;

      var oilData = {
        labels: [
          "Loading",
        ],
        datasets: [
          {
            //axis: 'y',
            data: [1, 2, 3, 4, 5],
            label: "Orders Booked",
            backgroundColor: [
              "#FF6384",
              "#63FF84",
              "#84FF63",
              "#8463FF",
              "#6384FF"
            ]
          }]
      };

      var barOptions = {
        plugins: {
          title: {
            display: true,
            text: 'Orders Booked',
            font: {
              size: 18
            }
          },
          legend: {
            display: false
          },
        }
      };

      return new Chart(oilCanvas, {
        type: 'bar',
        data: oilData,
        options: barOptions
      });

    };

    function resetTimer(newTime) {
      clearInterval(intTimer);
      intervalTime = newTime * 60000;
      intTimer = setInterval(runIntProcess, intervalTime);
    };

    function runIntProcess() {
      if (active1) {
        // collect variables
        timeFrameChange();
        if (document.getElementById('timeframe1').value === "3") {
          setDate(document.getElementById("start1").value, "start1");
          setDate(document.getElementById("end1").value, "end1");
        } //else {

        //}
        if (end1 < start1) {
          alert("End date must be after start date");
          chart1.clear();
          active1 = false;
          toggleActiveStatus("active1");
          return false;
        }
        let startStr = start1.format("yyyy,MM,DD") + ",00,00,00";
        let endStr = end1.format("yyyy,MM,DD") + ",23,59,59";

        let compnoStr = "10,90";
        var options = document.getElementById('comp1').selectedOptions;
        var values = Array.from(options).map(({ value }) => value);
        //console.log(values);
        if (values.length < 1) {
          alert("At least one company option must be selected");
          chart1.clear();
          active1 = false;
          toggleActiveStatus("active1");
          return false;
        }
        compnoStr = values.join(",");

        console.log("GET DATA");
        if (values.length > 0) {
          getData(chart1, compnoStr, startStr, endStr, start1, end1);
          return true;
        }
      }
    }

    function getData(pieChart, compno, start, end, mStart, mEnd) {
      let url = `http://trace.transontario.com/sktracing/wc.dll?sktracingprocess~operationswatch~&compno=${compno}&startdate=${start}&enddate=${end}`;
      console.log(url);
      //return false;
      fetch(url)
        .then(response => response.json())
        .then(data => {
          //console.log(data)
          elabels = [];
          etotals = [];
          if (!data || !isIterable(data)) {
            if (!tried) {
              tried = true;
              return getData(pieChart, compno, start, end, mStart, mEnd);
            }
            pieChart.clear();
            alert("No data found in selected range.");
            active1 = false;
            toggleActiveStatus("active1");
            return false;
          }
          for (emp of data) {
            let elabel = emp.fname + " " + emp.lname.charAt(0);
            elabels.push(elabel);
            etotals.push(emp.ototal);
          }
          //console.log(elabels, etotals);
          pieChart.data.labels = elabels;
          pieChart.data.datasets[0].data = etotals;
          if (data.length != current_num) {
            current_num = data.length;
            pieChart.data.datasets[0].backgroundColor = genColors(data.length);
          };
          let dateStr = "";
          if (mStart.isSame(mEnd, 'day')) {
            dateStr = mStart.format('MMM DD, YYYY');
          } else {
            dateStr = mStart.format('MMM DD, YYYY') + " to " + mEnd.format('MMM DD, YYYY');
          }
          let barOptions = {
            plugins: {
              title: {
                display: true,
                text: `Orders Booked: ${dateStr}`,
                font: {
                  size: 18
                }
              },
              legend: {
                display: false
              },
            }
          };
          pieChart.options = barOptions;
          pieChart.update();
          tried = false;
        });
    }
  </script>
  <script>
    var mytext = `#ffebee red lighten-5
#ffcdd2 red lighten-4
#ef9a9a red lighten-3
#e57373 red lighten-2
#ef5350 red lighten-1
#f44336 red
#e53935 red darken-1
#d32f2f red darken-2
#c62828 red darken-3
#b71c1c red darken-4
#ff8a80 red accent-1
#ff5252 red accent-2
#ff1744 red accent-3
#d50000 red accent-4
#fce4ec pink lighten-5
#f8bbd0 pink lighten-4
#f48fb1 pink lighten-3
#f06292 pink lighten-2
#ec407a pink lighten-1
#e91e63 pink
#d81b60 pink darken-1
#c2185b pink darken-2
#ad1457 pink darken-3
#880e4f pink darken-4
#ff80ab pink accent-1
#ff4081 pink accent-2
#f50057 pink accent-3
#c51162 pink accent-4
#f3e5f5 purple lighten-5
#e1bee7 purple lighten-4
#ce93d8 purple lighten-3
#ba68c8 purple lighten-2
#ab47bc purple lighten-1
#9c27b0 purple
#8e24aa purple darken-1
#7b1fa2 purple darken-2
#6a1b9a purple darken-3
#4a148c purple darken-4
#ea80fc purple accent-1
#e040fb purple accent-2
#d500f9 purple accent-3
#aa00ff purple accent-4
#ede7f6 deep-purple lighten-5
#d1c4e9 deep-purple lighten-4
#b39ddb deep-purple lighten-3
#9575cd deep-purple lighten-2
#7e57c2 deep-purple lighten-1
#673ab7 deep-purple
#5e35b1 deep-purple darken-1
#512da8 deep-purple darken-2
#4527a0 deep-purple darken-3
#311b92 deep-purple darken-4
#b388ff deep-purple accent-1
#7c4dff deep-purple accent-2
#651fff deep-purple accent-3
#6200ea deep-purple accent-4
#e8eaf6 indigo lighten-5
#c5cae9 indigo lighten-4
#9fa8da indigo lighten-3
#7986cb indigo lighten-2
#5c6bc0 indigo lighten-1
#3f51b5 indigo
#3949ab indigo darken-1
#303f9f indigo darken-2
#283593 indigo darken-3
#1a237e indigo darken-4
#8c9eff indigo accent-1
#536dfe indigo accent-2
#3d5afe indigo accent-3
#304ffe indigo accent-4
#e3f2fd blue lighten-5
#bbdefb blue lighten-4
#90caf9 blue lighten-3
#64b5f6 blue lighten-2
#42a5f5 blue lighten-1
#2196f3 blue
#1e88e5 blue darken-1
#1976d2 blue darken-2
#1565c0 blue darken-3
#0d47a1 blue darken-4
#82b1ff blue accent-1
#448aff blue accent-2
#2979ff blue accent-3
#2962ff blue accent-4
#e1f5fe light-blue lighten-5
#b3e5fc light-blue lighten-4
#81d4fa light-blue lighten-3
#4fc3f7 light-blue lighten-2
#29b6f6 light-blue lighten-1
#03a9f4 light-blue
#039be5 light-blue darken-1
#0288d1 light-blue darken-2
#0277bd light-blue darken-3
#01579b light-blue darken-4
#80d8ff light-blue accent-1
#40c4ff light-blue accent-2
#00b0ff light-blue accent-3
#0091ea light-blue accent-4
#e0f7fa cyan lighten-5
#b2ebf2 cyan lighten-4
#80deea cyan lighten-3
#4dd0e1 cyan lighten-2
#26c6da cyan lighten-1
#00bcd4 cyan
#00acc1 cyan darken-1
#0097a7 cyan darken-2
#00838f cyan darken-3
#006064 cyan darken-4
#84ffff cyan accent-1
#18ffff cyan accent-2
#00e5ff cyan accent-3
#00b8d4 cyan accent-4
#e0f2f1 teal lighten-5
#b2dfdb teal lighten-4
#80cbc4 teal lighten-3
#4db6ac teal lighten-2
#26a69a teal lighten-1
#009688 teal
#00897b teal darken-1
#00796b teal darken-2
#00695c teal darken-3
#004d40 teal darken-4
#a7ffeb teal accent-1
#64ffda teal accent-2
#1de9b6 teal accent-3
#00bfa5 teal accent-4
#e8f5e9 green lighten-5
#c8e6c9 green lighten-4
#a5d6a7 green lighten-3
#81c784 green lighten-2
#66bb6a green lighten-1
#4caf50 green
#43a047 green darken-1
#388e3c green darken-2
#2e7d32 green darken-3
#1b5e20 green darken-4
#b9f6ca green accent-1
#69f0ae green accent-2
#00e676 green accent-3
#00c853 green accent-4
#f1f8e9 light-green lighten-5
#dcedc8 light-green lighten-4
#c5e1a5 light-green lighten-3
#aed581 light-green lighten-2
#9ccc65 light-green lighten-1
#8bc34a light-green
#7cb342 light-green darken-1
#689f38 light-green darken-2
#558b2f light-green darken-3
#33691e light-green darken-4
#ccff90 light-green accent-1
#b2ff59 light-green accent-2
#76ff03 light-green accent-3
#64dd17 light-green accent-4
#ffee58 yellow lighten-1
#ffeb3b yellow
#fdd835 yellow darken-1
#fbc02d yellow darken-2
#f9a825 yellow darken-3
#f57f17 yellow darken-4
#ffff8d yellow accent-1
#ffff00 yellow accent-2
#ffea00 yellow accent-3
#ffd600 yellow accent-4
#fff8e1 amber lighten-5
#ffecb3 amber lighten-4
#ffe082 amber lighten-3
#ffd54f amber lighten-2
#ffca28 amber lighten-1
#ffc107 amber
#ffb300 amber darken-1
#ffa000 amber darken-2
#ff8f00 amber darken-3
#ff6f00 amber darken-4
#ffe57f amber accent-1
#ffd740 amber accent-2
#ffc400 amber accent-3
#ffab00 amber accent-4
#fff3e0 orange lighten-5
#ffe0b2 orange lighten-4
#ffcc80 orange lighten-3
#ffb74d orange lighten-2
#ffa726 orange lighten-1
#ff9800 orange
#fb8c00 orange darken-1
#f57c00 orange darken-2
#ef6c00 orange darken-3
#e65100 orange darken-4
#ffd180 orange accent-1
#ffab40 orange accent-2
#ff9100 orange accent-3
#ff6d00 orange accent-4
#fbe9e7 deep-orange lighten-5
#ffccbc deep-orange lighten-4
#ffab91 deep-orange lighten-3
#ff8a65 deep-orange lighten-2
#ff7043 deep-orange lighten-1
#ff5722 deep-orange
#f4511e deep-orange darken-1
#e64a19 deep-orange darken-2
#d84315 deep-orange darken-3
#bf360c deep-orange darken-4
#ff9e80 deep-orange accent-1
#ff6e40 deep-orange accent-2
#ff3d00 deep-orange accent-3
#dd2c00 deep-orange accent-4
#efebe9 brown lighten-5
#d7ccc8 brown lighten-4
#bcaaa4 brown lighten-3
#a1887f brown lighten-2
#8d6e63 brown lighten-1
#795548 brown
#6d4c41 brown darken-1
#5d4037 brown darken-2
#4e342e brown darken-3
#3e2723 brown darken-4
#e0e0e0 grey lighten-2
#bdbdbd grey lighten-1
#9e9e9e grey
#757575 grey darken-1
#616161 grey darken-2
#424242 grey darken-3
#212121 grey darken-4`;

    function genColors(gentotalcolors) {
      let mywords = mytext.split("\n");
      mywords = mywords.filter(word => word.length > 0);

      let multiple = 16;
      let cycle = 0;
      let gencolorcodes = [
        "#FF6384",
        "#63FF84",
        "#84FF63",
        "#8463FF",
        "#6384FF"
      ];
      prev_color1 = "";
      prev_color2 = "";
      // let's test if we can get any set
      while (gencolorcodes.length < gentotalcolors) {
        index = Math.floor(Math.random() * mywords.length);
        color_name = mywords[index].split(" ")[1];
        color_name = (color_name.split("-")[1]) ? color_name.split("-")[1] : color_name;
        // console.log(color_name);
        if (mywords[index] && color_name != prev_color1 && color_name != prev_color2) {
          //mywords[index]);
          gencolorcodes.push(mywords[index].split(" ")[0]);
          mywords.splice(index, 1);
          prev_color2 = prev_color1;
          prev_color1 = color_name;
        }
      }
      return gencolorcodes;
    };

    //mat loaders
    document.addEventListener('DOMContentLoaded', function () {
      var elems = document.querySelectorAll('select');
      var instances = M.FormSelect.init(elems, {});
    });

    document.addEventListener('DOMContentLoaded', function () {
      var elems = document.querySelectorAll('.datepicker');
      var today = new Date();
      var instances = M.Datepicker.init(elems, { maxDate: today });
    });

    // hide show functions
    function hider() {
      var checkbox = document.getElementById('hidetoggle');
      if (checkbox.checked != true) {
        //alert("hide it");
        var element = document.getElementById("opts_div");
        element.classList.add("hide");
      } else {
        //alert("show it");
        var element = document.getElementById("opts_div");
        element.classList.remove("hide");
      }
    }

    //document.getElementById('timeframe1').onchange = ;

    function timeFrameChange() {
      //console.log("change");
      var value = document.getElementById('timeframe1').value;
      if (value == 3) {
        [...document.querySelectorAll('.time1')].map(e => e.classList.remove("hide"));
      } else {
        [...document.querySelectorAll('.time1')].map(e => e.classList.add("hide"));
        if (value == 2) {
          start1 = moment().subtract(7, 'days');
          end1 = moment();
        } else {
          start1 = moment();//.subtract(1, 'days');
          end1 = moment();
        }
      }
    }

    function activateChart(id) {
      //cid = parseInt(id);
      eval("active" + id + "=true");
      var element = document.getElementById("chart1");
      //do show hide
      if (active1) {
        toggleActiveStatus("active1");
        element.classList.remove("hide");
        if (!chart1) {
          chart1 = createBlankChart("chart1");
        }
        setTimeout(() => {
          let rtnval = runIntProcess();
          if (!rtnval) {
            chart1.clear();
          }
        }, 1000);
      } else {
        element.classList.add("hide");
        toggleActiveStatus("active1");
        chart1.clear();
      }
    }

    function setDate(val, variable) {
      eval(variable + '= moment(val,"MMM DD, YYYY",true)');
      var result = eval(variable + ".isValid()");
      if (!result) { // set Date failed
        console.error("SET date failed!!", eval(variable), eval(val));
      }
    }

    function validateSelect1(sel) {
      var options = sel.selectedOptions;
      var values = Array.from(options).map(({ value }) => value);
      //console.log(sel.selectedOptions);
      if (values.length < 1) {
        alert("At least one select option must be selected");
      }
    }

    function isIterable(value) {
      return Symbol.iterator in Object(value);
    }

    function toggleActiveStatus(activeText) {
      let val = eval(activeText);
      if (val) { // is active
        let element = document.getElementById(activeText + "_off");
        element.classList.add("hide");
        element = document.getElementById(activeText + "_on");
        element.classList.remove("hide");
      } else {
        let element = document.getElementById(activeText + "_off");
        element.classList.remove("hide");
        element = document.getElementById(activeText + "_on");
        element.classList.add("hide");
        chart1.clear();
      }
    }

    timeFrameChange();
    hider();
  </script>
</body>

</html>